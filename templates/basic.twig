<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-2/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/css/tempusdominus-bootstrap-4.min.css">

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <title>{% block title %}HW6{% endblock %}</title>
</head>
<body>
{% include '.templates\menu.twig' %}


<div class="container">

<div class="row mt-5 justify-content-between">

    <div class="col-7">{% block content %}{% endblock %}</div>
    <div class="col-4" id="form-place">


    </div>
</div>

<template id="form_ukr">
  {% include '.templates\form_ukr.twig' %}
</template>

<template id="form_eng">
  {% include '.templates\form_eng.twig' %}
</template>



<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

<script>



    (function () {
        'use strict';
        window.addEventListener('load', function () {

            var forms = document.getElementsByClassName('needs-validation');

            var validation = Array.prototype.filter.call(forms, function (form) {
                form.addEventListener('submit', function (event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // import * as jwt from 'jsonwebtoken'
    // // const signature = 'MySuP3R_z3kr3t';
    // // const expiration = '6h';
    //
    // function generateToken(req){
    //
    //     return jwt.sign({
    //         auth:  'magic',
    //         agent: req.headers['user-agent'],
    //         exp:   Math.floor(new Date().getTime()/1000) + 7*24*60*60, // Зверніть увагу: у секундах!
    //     }, secret);  // secret визначено у змінній середовища JWT_SECRET
    // }


$(document).on('click', '.nav-link', function () {
    $(".nav-item").find(".active").removeClass("active");
})
$(document).ready(function() {


    $('a[href="' + location.pathname + '"]').closest('.nav-item').addClass('active');


//change form (language)
    let place = document.getElementById('form-place');
    var temp1 = document.getElementById('form_ukr');
    var temp2 = document.getElementById('form_eng');
    var clon1 = temp1.content.cloneNode(true);
    var clon2 = temp2.content.cloneNode(true);


    let lang = getCookie('lang');

    if(lang === 'eng'){
        place.appendChild(clon2);
    } else {
        place.appendChild(clon1);
    }

    const letter = true;//потім змінити

    $('#createNewUser').submit(function (e) {
        e.preventDefault();
        const tkn = Math.floor(new Date().getTime()/1000) + 7*24*60*60;
        if(letter){

            const sendEmail =  $(this).find('[name=email]').val();

            $.ajax({

                type: 'POST',
                url: '/api/aplication',
                dataType: 'json',
                data: JSON.stringify({
                    surname: $(this).find('[name=surname]').val(),
                    name: $(this).find('[name=name]').val(),
                    email: $(this).find('[name=email]').val(),
                    phone: $(this).find('[name=phone]').val(),
                    description: $(this).find('[name=description]').val(),
                    varificated:false,
                    token: tkn
                })
                ,
                beforeSend: function (x) {
                    x.setRequestHeader('Content-Type', 'application/json');
                },
                success:
                    function () {
                        if(lang === 'eng'){
                            alert("A confirmation email has been mailed!");
                        } else {
                            alert("Лист підтвердження надіслано на пошту!");
                        }
                        sendSpam(sendEmail, tkn);
                        $('#createNewUser').trigger('reset')
                        $('#modalConfirm').modal('hide');

                    },
                error: function (x) {
                    console.log(x.responseJSON);
                }
            });


        }
        else{
            $.ajax({
                type: 'POST',
                url: '/api/aplication',
                dataType: 'json',
                data: JSON.stringify({
                    surname: $(this).find('[name=surname]').val(),
                    name: $(this).find('[name=name]').val(),
                    email: $(this).find('[name=email]').val(),
                    phone: $(this).find('[name=phone]').val(),
                    description: $(this).find('[name=description]').val(),
                    varificated: true,
                    token: tkn
                }),
                beforeSend: function (x) {
                    x.setRequestHeader('Content-Type', 'application/json');
                },
                success:
                    function () {
                        if(lang === 'eng'){
                            alert("Aplication is sent!");
                        } else {
                            alert("Надіслано заявку !");
                        }

                        $('#createNewUser').trigger('reset')

                    },
                error: function (x) {
                    console.log(x.responseJSON);
                }
            });
        }});
});


$(document).on('click', '#btn_eng', function () {
    document.cookie = "lang=eng";
    location.reload();
    console.log(getCookie('lang'));
});

$(document).on('click', '#btn_ukr', function () {
    document.cookie = "lang=ukr";
    location.reload();
    console.log(getCookie('lang'));
})

function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

{% block script %}{% endblock %}
    function sendSpam(user,id) {

        $.ajax({
            url: '/api/users',
            success:

                $.ajax({
                    type: 'POST',
                    url: '/api/send',
                    dataType: 'json',

                    data: JSON.stringify({

                        text: "To confirm your aplication follow this link  "+ `http://localhost:8888/varification/`+id,
                        users: user
                    }),
                    beforeSend: function (x) {
                        x.setRequestHeader('Content-Type', 'application/json');
                    },
                    success: function () {

                        $('#sendBtn').attr("disabled", false);
                    },
                    error: function (x) {
                        $('#sendBtn').attr("disabled", false);
                    }
                })

        })

    }

</script>
</div>
</body>
</html>
